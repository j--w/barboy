<div class="{isBusy ? 'is-busy' : ''} status">
	<p hidden="{isBusy}">Ready to Pour!</p>
	<p hidden="{!isBusy}">Busy Pouring!</p>
</div>
<section class="drinks">
	{#each drinks as drink}
		<div class="drink">
			<h2>{drink.label}
				<small>
					{#each drink.ingredients as ingredient}
						<span>
							<span class="ingredient">{ingredient.ingredient}</span> <span class="amount">{ingredient.amount} mL</span>
						</span>
					{/each}
				</small></h2>
			<h3 hidden="{!drink.variations || drink.variations.length === 0}">
				Variations: {drink.variations}
			</h3>
			<button disabled="{isBusy}" on:click="startOrder(drink)">Order</button>
		</div>
	{:else}
		<div>No drinks available dumdum</div>
	{/each}
</section>
{#if activeDrink}
<div class="dialog-wrapper" hidden="{!activeDrink}">
	<div class="dialog">
		<h1>{activeDrink.label}</h1>
		{#if !orderInProgress}
		<h2>Set up your glass!</h2>
		<ol hidden="{orderInProgress}">
			<li>Add some ice</li>
			{#each activeDrink.preSteps as step}
			<li>{step}</li>
			{/each}
			<li>Place glass under nozzle</li>
		</ol>
		{/if}
		{#if orderInProgress}
		<h2>When it's finished pouring</h2>
		<ol hidden="{!orderInProgress}">
			{#each activeDrink.postSteps as step}
			<li>{step}</li>
			{/each}
			<li>Drink it dummy!</li>
		</ol>
		{/if}
		<button class="btn-done" hidden="{!orderInProgress || isBusy}" on:click="cancelOrder()">Done</button>
		<button hidden="{orderInProgress}" on:click="orderDrink(activeDrink)">Pour it!</button>
		<button hidden="{orderInProgress}" on:click="cancelOrder()">Cancel</button>
	</div>
</div>
{/if}


<style lang="sass">

	.dialog-wrapper {
		background: rgba( 0, 0, 0, 0.5);
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 500;
		display: flex;
		align-items: center;
		justify-content: center;

		.dialog {
			background: white;
			width: 75%;

			h1 {
				font-size: 25px;
			}

			button {
				width: calc(50% - 0.5rem);
				&.btn-done {
					width: 100%;
				}
			}

		}
	}
	.drinks {
		position: fixed;
		top: 2rem;
		right: 0;
		left: 0;
		bottom: 0;
		overflow: auto;
		z-index: 1;
	}
	.drink, .dialog {
		width: calc(100% - 2rem);
		margin: 1rem;
		border-radius: 1rem;
		box-shadow: 5px 5px 10px #888;
		background-color: white;
		padding: 1rem;

		small {
			> span {
				display: inline-block;
				padding: 0 0.5rem;
				border-right: solid 2px #666;
				font-size: 14px;
				&:last-child {
					border-right: none;
				}
			}
			color: #666;
			.ingredient {
				text-transform: capitalize;
			}
		}
		
		button {
			transition: opacity 0.2s ease-in-out;
			width: 100%;
		}

		button:disabled {
			opacity: 0.5;
		}
		
		h3 {
			font-size: 16px;
			color: #666;
		}
	}

	.status {
		position: fixed;
		z-index: 10;
		top: 0;
		left: 0;
		right: 0;
		height: 2rem;
		border-bottom: solid 3px white;
		font-size: 14px;
		color: white;
		text-align: center;
		pointer-events: none;
		&.is-busy {
			background: #CF000F;
		}
		p {
			margin: 0.2rem 0;
			padding: 0;
		}
	}
</style>

<script>
	export default {
		data: function() {
			return {
				drinks: [],
				sse: null,
				isBusy: false,
				activeDrink: null,
				orderInProgress: false			}
		},
		oncreate: function() {
			this.loadRecipes();
			this.subscribeToState();
		},
		methods: {
			subscribeToState() {
				this.sse = new EventSource(`http://${window.location.hostname}:3000/state`);
				this.sse.onmessage = (event) => {
					const eventData = JSON.parse(event.data);
					this.set({isBusy: eventData.busy});
				}
			},
			async loadRecipes() {
				try {
					const res = await fetch(`http://${window.location.hostname}:3000/recipes`)
					const drinks = await res.json();
					this.set({drinks});
				} catch( error ) {
					console.warn(error);
				}
				
			},
			startOrder(drink) {
				this.set({
					activeDrink: {
						preSteps:[],
						postSteps:[],
						...drink,
					}
				});
			},
			cancelOrder() {
				this.set({
					activeDrink: null,
					orderInProgress: false
				})
			},
			async orderDrink(drink) {
				try {
					this.set({
						orderInProgress: true
					})
					const res = await fetch(`http://${window.location.hostname}:3000/order`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json; charset=utf-8'
						},
						body: JSON.stringify({recipe: drink.id})
					});
				} catch( error ) {
					console.warn(error);
				}
				console.log(drink);
			}
		}
	}
</script>